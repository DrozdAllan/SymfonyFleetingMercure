{% extends 'base.html.twig' %}

{% block title %}Chat
{% endblock %}

{% block body %}
	<div class="container">
		{% for channel in channels %}

			{% for user in channel.users %}
				{% if app.user != user %}
					<h1>
						<b>
							{{user.username }}</b>
					</h1>
				{% endif %}
			{% endfor %}

			<div class="container" style="height: 600px">
				<div class="container bg-light h-75 overflow-auto">
					{% for message in channel.messages %}
						{% if app.user == message.user %}
							<div class="row w-75 float-right">
								<b>{{ message.user.username }}</b>
								<p class="alert alert-info w-100">
									{{ message.content }}
								</p>
							</div>
						{% else %}
							<div class="row w-75 float-left">
								<b>{{ message.user.username }}</b>
								<p class="alert alert-success w-100">
									{{ message.content }}
								</p>
							</div>
						{% endif %}
					{% endfor %}
				</div>
				<div>
					<form id="formChat" action="{{ asset('message') }}" method="post" class="container row js-data" data-channel="{{ channel.id }}">
						<input id="message" class="input-group-text col-sm-9" placeholder="Message" type="text"/>
						<button id="submit" type="submit" class="buttonChat btn btn-success col-sm-3">Send</button>
					</form>
				</div>
			</div>
		{% endfor %}
	</div>
{% endblock %}


{% block javascripts %}
    <script>

$(document).ready(function() {

    let chatDiv = document.querySelector('.overflow-auto');
    chatDiv.scrollTop = chatDiv.scrollHeight; // On souhaite scroller toujours jusqu'au dernier message du chat

    $("button.buttonChat").click(function(e) {
        e.preventDefault(); // Empêche la page de se rafraîchir après le submit du formulaire

		const inputBeforeButton = $(this).siblings('input');

		const message = inputBeforeButton[0].value;

		const channelNb = $(this).parent().data('channel');
            
		const data = { // La variable data sera envoyée au controller
            content: message, // On transmet le message...
			channel: channelNb // ... Et le canal correspondant
        };

        console.log(data); // Pour vérifier vos informations
            
		fetch('/message', { // Envoie du form en JSON vers le controller de messages
            method: 'POST',
            body: JSON.stringify(data) // On envoie les data sous format JSON
        }).then((response) => {
			if(response.ok) {
				inputBeforeButton[0].value = ''; // Efface le message dans l'input
				return response;
			} else {
				throw new Error('Something went wrong');
			}
		})
		.then((response) => {
            console.log(response);
		}) 
    });


});

    </script>
{% endblock %}